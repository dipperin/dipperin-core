language: go
go:
  - 1.13.x # required

dist: xenial

cache: false

notifications:
  email: false

sudo: required

addons:
  sonarcloud:
    organization: "$SONAR_ORG"
    token:
      secure: "$SONAR_TOKEN_dev"

services:
  - docker

git:
  submodules: false

before_install:
 # - docker pull karalabe/xgo-latest
 # - docker ps -a
 # - go get github.com/karalabe/xgo

install: true # skip install

script:
  - export GO111MODULE=on
  - go test -p 1 ./core/... ./cmd/... ./common/...
#script: make compile

after_script:
  - go test -p 1 -cover ./core/... ./cmd/... ./common/... -coverprofile=coverage.out
  - sonar-scanner


deploy:
  - provider: script
    script: bash cs.sh compile
    on:
      repo: dipperin/dipperin-core
      branch: master
      tags: true   #git tag


  - provider: releases
    api_key:
      secure: T6E/9a2nPxG4d4DKRGYh+GkeMZLLjdXwQ77DsLvaOYc0x6OgfNequcK6+CVGuO4N9UFOmRH54VJGwGq/ZVBtTpyLudQaaEJemG5bPFCkGtYJkmBDYGypPNYP1zKvGZtys7Fhqu2gWi4NVWvhK/laxwSk4K3K4sHCDONZ6y+7hcqEAA/hu023Eo+fYB+y2V7ERwAEYOlj7zZCab/uE1r0e6QMsk642Japd8mtT+iNXD9uR/VhpKRP+b1PjjRQ8aDhmxiUmMqZBN7OLWc3F3v7LAudO5WTqmdurN5FQ8wdFDF2NgzUWafxd/1zPHqj+/r8BujT3LDuDcEPmYZ5mjHnSqaak3LIrQWHtZsMv0Zo4ZajVYiIinrFjVuo542rn2L7S2+aefX+9LmM+u/uqAHWRZXNLRaEHqC8/AjseyKLhF44xTd9RpF29zTP7/snOkOcgc1afpBqcgUwUpu46P+nhs+oCO2xtMQC5PHchUwVgLopd+GjnxYhNRy3gQn6ir8S2DbJtpH432O0sHV8bAmce6AWxmoM3feXlvKUirI0o+nJM7ejetdR40qdA3FKZa8MYDEW5oHIo0Yjbl0VawnhVY7GeAZZTcdWpLPLWW7XV5BjKOx/eVAIXQcNruW4wTRjd8lLy261NBZ0Zr5/jWyFlyZ3Y540rDApJrq8mf5onNc=

    file:
      - "./cmd/dipperin/dipperin-linux-amd64"
      - "./cmd/dipperin/dipperin-windows-4.0-amd64.exe"
      - "./cmd/dipperin/dipperin-darwin-10.6-amd64"
    skip_cleanup: true # need upload
    on:
      repo: dipperin/dipperin-core
      branch: master
      tags: true   #git tag 时发布


